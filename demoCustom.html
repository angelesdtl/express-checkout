<!DOCTYPE html>
<html>
    <head>
    	<meta name="layout" content="deafult"/>
        <meta charset="utf-8">
        <title>Pagar</title>
        <link rel="stylesheet" type="text/css" href="https://a248.e.akamai.net/secure.mlstatic.com/checkout-resources/resourses/checkout/css/custom.css"/>
        <script>
        	//resize modal
        	if(self!=top && typeof window.parent.postMessage != 'undefined'){ 
           		window.parent.postMessage('{"action":"resize","data":{"width":"400","height":"370"}}', "*");
                } 
	</script>
        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="https://secure.mlstatic.com/org-img/checkout/custom/1.0/checkout.js"></script>
        
    </head>
    <body class="inline-frame">
        
  <div id="container">
  
  <div class="add-payment-method-view">

  <div class="payment-container">
  
  <div class="form-container">
  
  <div class="add-payment-method-form-view">

  <form action="" method="post" id="form-pagar-mp">

  <label class="card-label credit-card-number-label" for="credit-card-number">
    <span class="field-name">Card Number</span>
    <input data-checkout="cardNumber" id="cardNumber" class="card-field" type="tel" inputmode="numeric" placeholder="Card Number" autocomplete="off">
    <span class="payment-method-icon"></span>
    <div class="invalid-bottom-bar"></div>
  </label>

  <div class="row">

    <div class="column half">
      <label class="card-label expiration-label right-border show-label" for="expiration">
        <span class="field-name">MM / YYYY</span>
        <input id="expiration" class="expiration card-field" type="tel" inputmode="numeric" placeholder="Expiration Date" autocomplete="off" maxlength="7">
        <div class="invalid-bottom-bar"></div>
      </label>
    </div>
    
    <div class="column half">
      <label class="card-label cvv-label" for="cvv">
        <span class="field-name">CVV (3 digits)</span>
        <input id="securityCode" data-checkout="securityCode" class="cvv card-field" maxlength="3" type="tel" inputmode="numeric" placeholder="CVV" autocomplete="off" autocapitalize="off">
        <span class="payment-method-icon" id="undefined"></span>
        <div class="invalid-bottom-bar"></div>
      </label>
    </div>

    <div class="column half">
        <label class="card-label" for="doc-number">
            <span class="field-name">Doc Number</span>
            <input id ="docNumber" data-checkout="docNumber" maxlength="15" class="card-field" type="text" placeholder="Doc Number">
            <span class="payment-method-icon"></span>
            <div class="invalid-bottom-bar"></div>
        </label>
    </div>

    <div class="column half">
        <label class="card-label" for="credit-card-holderName">
            <span class="field-name">Card Holder Name</span>
            <input id="cardholderName" data-checkout="cardholderName" maxlength="30" class="card-field" type="text" placeholder="Card Holder Name">
            <span class="payment-method-icon"></span>
            <div class="invalid-bottom-bar"></div>
        </label>
    </div>
	<p><input class="demoSubmit" type="submit" value="Pay $20"></p>
    <input data-checkout="docType" type="hidden" value="DNI"/>

  </div>
  
</form>

<div class="server-error">
  <div class="server-error-message-container">
    <div class="server-error-message">
      <span class="error-icon"></span>There was an error processing your request. <a href="#" class="error-retry">Try again</a>
    </div>
  </div>
</div>
</div></div>

</div>
      <!--Start checkout integration -->
        <script type="text/javascript">
              Checkout.setPublishableKey("841d020b-1077-4742-ad55-7888a0f5aefa");
              
            $("#form-pagar-mp").submit(function( event ) {
                
                var $form = $(this);

                //legacy mode
                var expires = document.getElementById('expiration').value;
                var expiresSplit = expires.split('/');
                var expirationYear= expiresSplit[1];
                var expirationMont= expiresSplit[0];

                $form.append($('<input type="hidden" data-checkout="cardExpirationMonth"/>').val(expirationMont));
                $form.append($('<input type="hidden" data-checkout="cardExpirationYear"/>').val(expirationYear));

                Checkout.createToken($form, mpResponseHandler);
                event.preventDefault();
                return false;
            });

            var mpResponseHandler = function(status, response) {
                var $form = $('#form-pagar-mp');

                    if (status != 200) {
                        checkErrors(response);
                    } 
                    else {
                        var card_token_id = response.id;
                        var callbackJson = '{"card_token_id" :"'+response.id+'"}';
                        finalizeRender(callbackJson);
                    }
            } 

                    //Manage labels
                    function showLabel(atributte){
                        atributte.addClass("show-label");    
                    }
                    function hideLabel(atributte){
                        atributte.removeClass("show-label");    
                    }
                    //Manage active inputs
                    function activeInput(atributte){
                        atributte.addClass("active");    
                    }
                    function deactiveInput(atributte){
                        atributte.removeClass("active");    
                    }
                    //Manage Errors
                    function showError(atributte){
                        atributte.addClass("invalid");    
                    }
                    function hideError(atributte){
                        atributte.removeClass("invalid"); 
                    }

                    function checkErrors(response){
                        for (index = 0;response.cause && index < response.cause.length; index++) {
                           if (response.cause[index] != null) {
                                var errorCode = response.cause[index].code;
                                checkAndActiveError(errorCode);
                           }
                        }
                    }
                    function checkAndActiveError(errorCode){
                    
                    	if(errorCode == "E301" || errorCode == "205"){
				            showError($('label[for="credit-card-number"]'));
				        }
				        if(errorCode == "E302" || errorCode == "224"){
				            showError($('label[for="cvv"]'));
				        }
				        if(errorCode == "221"){
				            showError($('label[for="credit-card-holderName"]'));
				        }
				        if(errorCode == "324" || errorCode == "214"){
				            showError($('label[for="doc-number"]'));
				        }
				        if(errorCode == "208" || errorCode == "209" || errorCode == "325" || errorCode == "326"){
				            showError($('label[for="expiration"]'));
				        }
                    }
                    //Manage binding

                    $("#cardNumber, #securityCode, #cardholderName, #docNumber, #expiration").on({
                        focus: function(e){
                            inputLabel = $(this).parent();
                            activeInput(inputLabel);
                            hideError(inputLabel);
                            if($(this).attr('id')=="securityCode"){
                                if(guessedCardId=='amex'){
                                    inputLabel.children("span[class='payment-method-icon']").attr('id', 'cid-icon');    
                                    inputLabel.children("span[class='field-name']").text("CVV (4 digits)");
                                    inputLabel.children("input[class='cvv card-field']").attr("maxlength", "4");
                                    inputLabel.children("input[class='cvv card-field']").attr("placeholder","CID");
                                }else{
                                    inputLabel.children("span[class='payment-method-icon']").attr('id', 'cvv-icon');
                                    inputLabel.children("span[class='field-name']").text("CVV (3 digits)");
                                    inputLabel.children("input[class='cvv card-field']").attr("maxlength", "3"); 
                                    inputLabel.children("input[class='cvv card-field']").attr("placeholder","CVV");   
                                }
                            }
                        },
                        focusout: function(e){
                            inputLabel = $(this).parent();
                            deactiveInput(inputLabel);
                            if($(this).attr('id')=="securityCode"){
                                deactiveInput(inputLabel);
                                inputLabel.children("span[class='payment-method-icon']").attr('id', 'undefined');
                            }  
                        }

                    });

                    //keyUp
                    $("#cardNumber").on("keyup paste", 
                        function(e){
                            if(e.type=="keyup"){
                                var ccNumber = $("#cardNumber").val().replace(/ /g, '').replace(/-/g, '').replace(/\./g, '');
                                switch(ccNumber.length) {
                                    case 0:
                                        hideLabel($('label[for="credit-card-number"]'));
                                        break;
                                    case 1:
                                        $('label[for="credit-card-number"]').children("span[class='payment-method-icon "+guessedCardId+"']").removeClass(guessedCardId);
                                        break;
                                    case 6:
                                    	guessingCreditCardNumber(ccNumber);
                                        Checkout.getPaymentMethod(ccNumber,setPaymentMethodInfo);
                                        break;
                                    default:
                                    	showLabel($('label[for="credit-card-number"]'));
                                    	break;
                                }
                                forceFormat();
                            }else{
                                var ccNumber;

                                setTimeout(function() {
                                    ccNumber = $("#cardNumber").val().replace(/ /g, '').replace(/-/g, '').replace(/\./g, '');   
                                    if(ccNumber.length>1){
                                     var ccNumberLabel = $('label[for="credit-card-number"]');
                                    showLabel(ccNumberLabel);
                                    ccNumberLabel.children("span[class='payment-method-icon "+guessedCardId+"']").removeClass(guessedCardId);
                                    }
                                    if(ccNumber.length>6){
                                        ccNumber=ccNumber.toString().substring(0,6);
                                        guessingCreditCardNumber(ccNumber);
                                        Checkout.getPaymentMethod(ccNumber,setPaymentMethodInfo);
                                    }
                                    forceFormat();

                                }, 100);
                            }
                            
                    });
                    $("#securityCode").bind("keyup paste", 
                        function(e){
                            if(e.type=="keyup"){
                                var cvv = $('#securityCode').val();
                                switch(cvv.length) {
                                    case 0:
                                        hideLabel($('label[for="cvv"]'));
                                        break;
                                    default:
                                        showLabel($('label[for="cvv"]'));
                                        break;
                                }
                            }else{
                                showLabel($('label[for="cvv"]'));
                            }
                            
                    });
                    $("#docNumber").bind("keyup paste", 
                        function(e){
                            if(e.type=="keyup"){
                                var docNumber = $('#docNumber').val();
                                switch(docNumber.length) {
                                    case 0:
                                        hideLabel($('label[for="doc-number"]'));
                                        break;
                                    default:
                                        showLabel($('label[for="doc-number"]'));
                                        break;
                                }
                            }else{
                                showLabel($('label[for="doc-number"]'));
                            }
                            
                    });
                    $("#cardholderName").bind("keyup paste", 
                        function(e){
                            if(e.type=="keyup"){
                                var cholderName = $('#cardholderName').val();
                                 switch(cholderName.length) {
                                    case 0:
                                        hideLabel($('label[for="credit-card-holderName"]'));
                                        break;
                                    default:
                                        showLabel($('label[for="credit-card-holderName"]'));
                                        break;
                                }
                            }else{
                                showLabel($('label[for="credit-card-holderName"]'));
                            }
                            
                    });

                    $("#expiration").bind("keyup paste", 
                        function(e){
                            var expiration = $("#expiration").val();
                            if(expiration.length>=2 && expiration.indexOf("/") == -1){
                                $("#expiration").val(spliceSplit(expiration,2,0,"/"));
                            }
                            
                    });



                    //Format functions
                    var guessedCardId="visa";
                    var applyFormat = function(value, digit, pos, separator) {

                    var steps;
                        switch (guessedCardId) {
                            case 'amex':
                                steps = [4, 6, 5];
                                break;
                            default:
                                steps = [4, 4, 4];
                        }
                        value = value.slice(0, pos) + digit + value.slice(pos);
                        value = value.replace(/\D/g, '');

                        var parts = [];
                        while (steps.length) {
                            var step = steps.shift(),
                                part1 = value.slice(0, step),
                                part2 = value.slice(step);
                            
                            parts.push(part1);
                            value = part2;
                        }
                        if (value !== "") {
                            parts.push(value);
                        }

                        return $.trim(parts.join(separator));
                    };

                    var getCursorPosition = function(target) {
                    var start = 0,
                        end = 0,
                        input = target.get(0);

                    if (document.selection) { // IE
                        input.focus();
                        var sel = document.selection.createRange();
                        var selLen = document.selection.createRange().text.length;
                        sel.moveStart('character', -input.value.length);
                        start = sel.text.length - selLen;
                        end = start + selLen;
                    } else if (input && $(input).is(':visible') && input.selectionStart !== null) { // Firefox/Webkit
                        start = input.selectionStart;
                        end = input.selectionEnd;
                    }

                    return {
                        "start": start,
                        "end": end
                    };
                    };
                      
                    var setCursorPosition = function(input, start, end) {
                        return input.filter(':visible').each(function() {
                            input = input[0];
                            if (input.setSelectionRange) { // FF/Webkit
                                input.focus();
                                input.setSelectionRange(start, end);
                            } else if (input.createTextRange) { // IE
                                var range = input.createTextRange();
                                range.collapse(true);
                                range.moveEnd('character', end);
                                range.moveStart('character', start);
                                if (end - start >= 0) {
                                    range.select();
                                }
                            }
                        });
                    };
                    var forceFormat = function() {
                    var target = $("#cardNumber"), 
                        coord = getCursorPosition(target),
                        val = target.val(),
                        length = val.length,
                        pos,
                        maxLength = guessedCardId === 'amex' ? 15 : 16;
                    
                    if(val.replace(/\D/g, '').length > maxLength) { // para que no pueda pegar mas alla del limite de caracteres
                        val = val.replace(/\D/g, '').slice(0, maxLength);
                    }
                    
                    target.val(applyFormat(val, '', 0, ' '));
                    
                    if (coord.start !== length) { // si esta al final
                        pos = coord.start; // dejo el cursor donde estaba
                    } else {
                        pos = target.val().length;; // sino, me aseguro que quede al final
                    }
                    
                    setCursorPosition(target, pos, pos);
                    };

                    //a generic splice
                    function spliceSplit(str, index, count, add) {
                      var ar = str.split('');
                      ar.splice(index, count, add);
                      return ar.join('');
                    }
                    //manage PMT
                    function setPaymentMethodInfo(status, result){
                      $.each(result, function(p, r){
                          $.each(r.labels, function(pos, label){
                              if (label == "recommended_method") {
                                  guessedCardId = r.id;
                                  var cvvLabel = $('label[for="cvv"]');
                                    if(guessedCardId=='amex'){  
                                        cvvLabel.children("span[class='field-name']").text("CVV (4 digits)");
                                        cvvLabel.children("input[class='cvv card-field']").attr("maxlength", "4");
                                        cvvLabel.children("input[class='cvv card-field']").attr("placeholder","CID"); 
                                    }else{
                                        cvvLabel.children("span[class='field-name']").text("CVV (3 digits)");
                                        cvvLabel.children("input[class='cvv card-field']").attr("maxlength", "3");
                                        cvvLabel.children("input[class='cvv card-field']").attr("placeholder","CVV");    
                                    }
                                  return;
                              }
                          });
                      });
                    };
                    //manage credit card
                    ccPmtRegex={"naranja":"^((402917)|(402918)|(527571)|(527572))","argencard":"^(501105)","visa":"^4","amex":"^3","master":"^5"};
                    
                    function guessingCreditCardNumber(ccNumber){
                    	for (var pmt in ccPmtRegex){
                    		if(ccNumber.match(ccPmtRegex[pmt])){
                    			$('label[for="credit-card-number"]').children("span[class='payment-method-icon']").addClass(pmt);
                    		}
                    	}
                    	return "unknown";
                    }

    </script>
</body>
</html>
